function Timer(){var a,b,c,d;this.pause=function(){window.clearTimeout(b),d-=new Date-c},this.resume=function(){c=new Date,window.clearTimeout(b),b=window.setTimeout(a,d)},this.cancel=function(){window.clearTimeout(b),a=null},this.start=function(c,e){a=c,d=e,b=window.setTimeout(a,d)}}function TtsPlayer(){function c(){b.addEventListener("pause",d),b.addEventListener("play",e)}function d(){a.internalEvents.onPause(),a.wordHighlighter.pause()}function e(){if(a.internalEvents.onPlay(),a.currentContext.positions.length)if(a.audioSource.currentTime()>0)a.wordHighlighter.resume();else var b=setInterval(function(){a.audioSource.currentTime()>0&&(clearInterval(b),a.wordHighlighter.start(a.currentContext.item,a.currentContext.positions).then(function(b){a.events.onSentenceComplete(b)}))},20)}function f(){b=null;var c=document.getElementById("talkify-audio");c&&(c.outerHTML="");var d=document.createElement("source"),e=document.createElement("source");b=document.createElement("audio"),b.appendChild(d),b.appendChild(e),d.type="audio/mpeg",e.type="audio/wav",b.id="talkify-audio",b.controls=!talkifyConfig.ui.audioControls.enabled,b.autoplay=!0,document.body.appendChild(b);var f=b.cloneNode(!0);b.parentNode.replaceChild(f,b),b=f,a.mutateControls(function(){a.playbar.instance.subscribeTo({onPlayClicked:function(){a.play()},onPauseClicked:function(){a.audioElement.pause()},onVolumeChanged:function(b){a.audioElement.volume=b/10},onRateChanged:function(b){a.settings.rate=b}}).setRate(1).setMinRate(1).setMaxRate(3).setVoice(a.forcedVoice).setAudioSource(b)})}var b,a=this;this.currentContext={item:null,positions:[]},this.playbar={instance:null},this.audioSource={play:function(){b.play()},pause:function(){b.pause()},isPlaying:function(){return b.duration>0&&!b.paused},paused:function(){return b.paused},currentTime:function(){return b.currentTime},stop:function(){b.pause(),b.currentTime=0}},this.__proto__.__proto__=new BasePlayer(this.audioSource,this.playbar),f.apply(this),this.audioElement=b,c()}function talkifyPlaybar(a){function q(a){a.classList.contains("talkify-hidden")||(a.className+=" talkify-hidden")}function r(a){a.className=a.className.replace("talkify-hidden","")}function s(){q(c),r(d)}function t(){q(d),r(c)}function u(a,b){a.classList.contains(b)||(a.className+=" "+b)}function v(a,b){a.className=a.className.replace(b,"")}function w(){var a=document.getElementById("htmlPlaybar");a&&a.parentNode.removeChild(a),n=document.createElement("section"),n.id="htmlPlaybar",n.className="talkify-audio-control",o=document.createElement("div"),o.className="talkify-audio-control-voice-wrapper",o.textContent="Speaking:",h=document.createElement("span"),k=document.createElement("i"),k.className="fa fa-cc talkify-clickable talkify-disabled",k.title="Toggle text highlighting (applied for the next paragraph)",o.appendChild(h),o.appendChild(k),l=document.createElement("div"),l.className="talkify-inline",i=document.createElement("span"),i.id="talkify-current-track-time",i.textContent="0:00",j=document.createElement("span"),j.id="talkify-track-time",j.textContent="0:00",l.appendChild(i),l.appendChild(document.createTextNode("/")),l.appendChild(j),g=document.createElement("progress"),g.setAttribute("value","0.0"),g.setAttribute("max","1.0");var p=document.createElement("i");p.className="fa fa-backward fa-2x talkify-clickable",c=document.createElement("i"),c.className="fa fa-play-circle fa-2x talkify-clickable",d=document.createElement("i"),d.className="fa fa-pause fa-2x talkify-clickable";var q=document.createElement("i");q.className="fa fa-forward fa-2x talkify-clickable",m=document.createElement("div"),m.className="talkify-wrapper talkify-inline";var r=document.createElement("i");r.className="fa fa-tachometer",e=document.createElement("input"),e.setAttribute("type","range"),e.setAttribute("value","5"),e.setAttribute("min","0"),e.setAttribute("max","10"),e.setAttribute("title","Adjust playback speed");var s=document.createElement("i");s.className="fa fa-volume-up",f=document.createElement("input"),f.setAttribute("type","range"),f.setAttribute("value","10"),f.setAttribute("min","0"),f.setAttribute("max","10"),e.setAttribute("title","Adjust playback volume"),n.appendChild(o),n.appendChild(l),n.appendChild(c),n.appendChild(d),n.appendChild(g),n.appendChild(m),m.appendChild(r),m.appendChild(e),m.appendChild(s),m.appendChild(f),b.parentElement.appendChild(n),t()}function x(){c.addEventListener("click",function(){p.onPlayClicked()}),d.addEventListener("click",function(){p.onPauseClicked()}),e.addEventListener("change",function(){p.onRateChanged(parseInt(this.value))}),f.addEventListener("change",function(a){p.onVolumeChanged(parseInt(this.value))}),k.addEventListener("click",function(a){k.classList.contains("talkify-disabled")?v(k,"talkify-disabled"):u(k,"talkify-disabled"),p.onTextHighlightingClicked()})}function y(){w(),x()}function z(a){a instanceof Node&&a.addEventListener("timeupdate",function(a){g.setAttribute("value",a.target.currentTime/a.target.duration);var b=document.getElementById("talkify-current-track-time"),c=document.getElementById("talkify-track-time"),d=Math.floor(a.target.currentTime/60),e=Math.round(a.target.currentTime)-60*d;b.textContent=d+":"+(e<10?"0"+e:e),d=Math.floor(a.target.duration/60),e=Math.round(a.target.duration)-60*d,c.textContent=d+":"+(e<10?"0"+e:e)},!0)}function A(){n.insertBefore(o,m),u(o,"talkify-inline")}function B(){n.insertBefore(o,l),v(o,"talkify-inline"),r(o)}function C(a){return a&&a.isTalkify}function D(a){r(g),B(),r(k),a&&(C(a)||(q(l),a.localService||(q(g),A(),q(k))))}function E(a){return a?C(a)?void(h.textContent=a.description):void(h.textContent=a.name):void(h.textContent="Automatic voice detection")}var c,d,e,f,g,h,i,j,k,l,m,n,o,b={parentElement:a||talkifyConfig.ui.audioControls.container||document.body},p={onPlayClicked:function(){},onPauseClicked:function(){},onVolumeChanged:function(){},onRateChanged:function(){},onTextHighlightingClicked:function(){}};return y(),{subscribeTo:function(a){return p.onPauseClicked=a.onPauseClicked||p.onPauseClicked,p.onPlayClicked=a.onPlayClicked||p.onPlayClicked,p.onRateChanged=a.onRateChanged||p.onRateChanged,p.onVolumeChanged=a.onVolumeChanged||p.onVolumeChanged,p.onTextHighlightingClicked=a.onTextHighlightingClicked||p.onTextHighlightingClicked,this},setRate:function(a){return e.setAttribute("value",a),this},setMaxRate:function(a){return e.setAttribute("max",a),this},setMinRate:function(a){return e.setAttribute("min",a),this},markAsPaused:t,markAsPlaying:s,setTextHighlight:function(a){return a?void v(k,"talkify-disabled"):void u(k,"talkify-disabled")},setProgress:function(a){g.setAttribute("value",a)},setVoice:function(a){return D(a),E(a),this},setAudioSource:function(a){z(a)}}}talkifyConfig={host:"",ui:{audioControls:{enabled:!1,container:document.body}}};var TalkifyWordHighlighter=function(){function c(a,c,d){f(),b=a;var e=a.element.text().trim();return 0===d?void a.element.html('<span class="talkify-word-highlight">'+e.substring(0,c.length)+"</span> "+e.substring(c.length+1)):void a.element.html(e.substring(0,d)+'<span class="talkify-word-highlight">'+e.substring(d,d+c.length)+"</span>"+e.substring(d-1+c.length+1))}function d(b,d){var e=new promise.Promise;if(a.cancel(),f(),!d.length)return e.done(b);var g=0,h=function(){if(c(b,d[g].Word,d[g].CharPosition),g++,g>=d.length)return a.cancel(),void window.setTimeout(function(){b.element.html(b.originalElement.html()),e.done(b)},1e3);var f=d[g].Position-d[g-1].Position+0;a.cancel(),a.start(h,f)};return h(),e}function e(){a.cancel(),f()}function f(){b&&b.element.html(b.originalElement.html())}var a=new Timer,b=null;return{pause:a.pause,resume:a.resume,start:d,highlight:c,cancel:e}};!function(a){function b(){this._callbacks=[]}function c(a){function g(a){return function(){e+=1,d[a]=Array.prototype.slice.call(arguments),e===f&&c.done(d)}}var c=new b,d=[];if(!a||!a.length)return c.done(d),c;for(var e=0,f=a.length,h=0;h<f;h++)a[h].then(g(h));return c}function d(a,c){var e=new b;return 0===a.length?e.done.apply(e,c):a[0].apply(null,c).then(function(){a.splice(0,1),d(a,arguments).then(function(){e.done.apply(e,arguments)})}),e}function e(a){var b="";if("string"==typeof a)b=a;else{var c=encodeURIComponent;for(var d in a)a.hasOwnProperty(d)&&(b+="&"+c(d)+"="+c(a[d]))}return b}function f(){var a;if(window.XMLHttpRequest)a=new XMLHttpRequest;else if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){a=new ActiveXObject("Microsoft.XMLHTTP")}return a}function g(a,c,d,g){function m(){j.abort(),h.done(i.ETIMEOUT,"",j)}var j,k,h=new b;d=d||{},g=g||{};try{j=f()}catch(a){return h.done(i.ENOXHR,""),h}k=e(d),"GET"===a&&k&&(c+="?"+k,k=null),j.open(a,c),j.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var l in g)g.hasOwnProperty(l)&&j.setRequestHeader(l,g[l]);var n=i.ajaxTimeout;if(n)var o=setTimeout(m,n);return j.onreadystatechange=function(){if(n&&clearTimeout(o),4===j.readyState){var a=!j.status||(j.status<200||j.status>=300)&&304!==j.status;h.done(a,j.responseText,j)}},j.send(k),h}function h(a){return function(b,c,d){return g(a,b,c,d)}}b.prototype.then=function(a,c){var d;return this._isdone?d=a.apply(c,this.result):(d=new b,this._callbacks.push(function(){var b=a.apply(c,arguments);b&&"function"==typeof b.then&&b.then(d.done,d)})),d},b.prototype.done=function(){this.result=arguments,this._isdone=!0;for(var a=0;a<this._callbacks.length;a++)this._callbacks[a].apply(null,arguments);this._callbacks=[]};var i={Promise:b,join:c,chain:d,ajax:g,get:h("GET"),post:h("POST"),put:h("PUT"),del:h("DELETE"),ENOXHR:1,ETIMEOUT:2,ajaxTimeout:0};"function"==typeof define&&define.amd?define(function(){return i}):a.promise=i}(this);var Html5Player=function(){this.isStopped=!1,this.volume=1,this.currentContext={item:null,endedCallback:function(){},utterances:[],currentUtterance:null};var a=this;this.playbar={instance:null},this.audioSource={play:function(){a.currentContext.item&&a.playCurrentContext()},pause:function(){window.speechSynthesis.pause(),a.internalEvents.onPause()},ended:function(){return!window.speechSynthesis.speaking},isPlaying:function(){return window.speechSynthesis.speaking},paused:function(){return!window.speechSynthesis.speaking},currentTime:function(){return 0},cancel:function(b){b?a.stop():window.speechSynthesis.cancel()},stop:function(){a.stop()}},this.__proto__.__proto__=new BasePlayer(this.audioSource,this.playbar),a.mutateControls(function(b){b.subscribeTo({onPlayClicked:function(){a.audioSource.play()},onPauseClicked:function(){a.pause()},onVolumeChanged:function(b){a.volume=b/10},onRateChanged:function(b){a.settings.rate=b/5}}).setVoice(this.forcedVoice)})};Html5Player.prototype.extractWords=function(a,b){var c=new RegExp(/[&\$\-|]|([("\-&])*(\b[^\s]+[.:,"-)!&?]*)/g);if(b){if(b.indexOf("zh-")>-1)return a.split("，");if(b.indexOf("ko-")>-1)return a.split(".")}for(var e,d=[];null!==(e=c.exec(a));)e.index===c.lastIndex&&c.lastIndex++,d.push(e[0]);return d},Html5Player.prototype.getVoice=function(){var a=new promise.Promise,b=this;if(this.forcedVoice)return a.done(this.forcedVoice),a;if(window.speechSynthesis.getVoices().length){var c=window.speechSynthesis.getVoices();return a.done(b.selectVoiceToPlay(c)),a}return window.speechSynthesis.onvoiceschanged=function(){var c=window.speechSynthesis.getVoices();a.done(b.selectVoiceToPlay(c))},a},Html5Player.prototype.selectVoiceToPlay=function(a){for(var b=[],c=null,d=this.settings.lockedLanguage||this.settings.referenceLanguage.Culture,e=0;e<a.length;e++)a[e].lang===d&&(b.push(a[e]),c=a[e]);for(var f=0;f<b.length;f++)if(b[f].localService){c=b[f];break}return!c&&b.length&&(c=b[0]),!c&&a.length&&(c=a[0]),c},Html5Player.prototype.chunckText=function(a){var b=this.settings.lockedLanguage||this.settings.referenceLanguage.Culture,c=b.indexOf("zh-")>-1?70:b.indexOf("ko-")>-1?130:200,d=[],e=a.split(/(\?|\.|。)+/g),f="",g=this;return e.forEach(function(a){if(""===a||"."===a||"。"===a||"?"===a)return void(f&&(f+=a));if(f&&f.length+a.length>c&&(d.push(f),f=""),a.length>c){var e=g.extractWords(a,b);return e.forEach(function(a){f.length+a.length>c&&(d.push(f),f=""),f+=a.trim()+" "}),void(f.trim()&&(d.push(f.trim()+"."),f=""))}f+=a}),d.push(f),d},Html5Player.prototype.playAudio=function(a,b){this.currentContext.endedCallback=b,this.currentContext.item=a,this.currentContext.utterances=[],this.currentContext.currentUtterance=null;var c=this;return c.playCurrentContext()},Html5Player.prototype.playCurrentContext=function(){var a=this.currentContext.item,b=this.currentContext.endedCallback,c=this.chunckText(a.text),d=this;d.currentContext.utterances=[],d.isStopped=!1,c.forEach(function(a){var b=new window.SpeechSynthesisUtterance;b.text=a,b.lang=d.settings.lockedLanguage||d.settings.referenceLanguage.Culture,b.rate=d.settings.rate,b.volume=d.volume,d.currentContext.utterances.push(b)});var e=new promise.Promise,f=0,g=0,h=this.extractWords(a.text);return d.currentContext.utterances[d.currentContext.utterances.length-1].onend=function(c){d.events.onSentenceComplete(a),d.currentContext.currentUtterance&&d.currentContext.currentUtterance.text===c.currentTarget.text&&b&&!d.isStopped&&b()},d.currentContext.utterances.forEach(function(b,c){0===c?b.onstart=function(a){d.currentContext.currentUtterance=a.utterance,e.done(),d.internalEvents.onPlay()}:b.onstart=function(a){d.currentContext.currentUtterance=a.utterance},b.onpause=function(){d.internalEvents.onPause()},b.onresume=function(){},b.onboundary=function(c){if("word"===c.name&&h[f]&&(d.mutateControls(function(a){a.setProgress((f+1)/h.length)}),d.settings.useTextHighlight&&b.voice.localService)){for(var e=0,i=0;i<f;i++)e+=h[i].length+1;var j=g+1===c.charIndex;if(j)return void(g=c.charIndex);d.wordHighlighter.highlight(a,h[f],e),f++,g=c.charIndex}},d.getVoice().then(function(c){h.length&&d.settings.useTextHighlight&&c.localService&&d.wordHighlighter.highlight(a,h[0],0),b.voice=c,console.log(b),window.speechSynthesis.cancel(),d.mutateControls(function(a){a.setVoice(c)}),window.setTimeout(function(){window.speechSynthesis.speak(b)},100)})}),e},Html5Player.prototype.stop=function(){this.isStopped=!0,this.internalEvents.onPause(),window.speechSynthesis.cancel(),this.currentContext.utterances.indexOf(this.currentContext.currentUtterance)<this.currentContext.utterances.length-1&&(console.log("Not the last, finishing anyway..."),this.events.onSentenceComplete(this.currentContext.item))},Html5Player.prototype.setVolume=function(a){return this.volume=a,this},TtsPlayer.prototype.getPositions=function(){var a=this,b=new promise.Promise;return talkifyHttp.get("/api/Speak/GetPositions?id="+a.id).then(function(a,c){b.done(null,c)}),b},TtsPlayer.prototype.playAudio=function(a,b){var c=this;c.currentContext.item=a,c.currentContext.positions=[];var d=new promise.Promise,e=this.audioElement.getElementsByTagName("source"),f=encodeURIComponent(a.text.replace(/\n/g," ")),g=this.forcedVoice?this.forcedVoice.name:"";return e[0].src=talkifyConfig.host+"/api/Speak?format=mp3&text="+f+"&refLang="+this.settings.referenceLanguage.Language+"&id="+this.id+"&voice="+g+"&rate="+this.settings.rate,e[1].src=talkifyConfig.host+"/api/Speak?format=wav&text="+f+"&refLang="+this.settings.referenceLanguage.Language+"&id="+this.id+"&voice="+g+"&rate="+this.settings.rate,this.audioElement.load(),$(this.audioElement).unbind("loadeddata").bind("loadeddata",function(){return c.audioSource.pause(),c.settings.useTextHighlight?void c.getPositions().then(function(a,b){c.currentContext.positions=b||[],d.done(),c.audioSource.play()}):(d.done(),void c.audioSource.play())}).unbind("ended.justForUniqueness").bind("ended.justForUniqueness",b||function(){}),d};var talkifyHttp=function(){var b=function(a){var b=new promise.Promise;return promise.get(window.talkifyConfig.host+a).then(function(a,c){try{var d=JSON.parse(c);b.done(a,d)}catch(a){b.done(a,c)}}),b};return{get:b}}(),BasePlayer=function(a,b){this.audioSource=a,this.wordHighlighter=new TalkifyWordHighlighter,this.id=this.generateGuid();var c=this;this.settings={useTextHighlight:!1,referenceLanguage:{Culture:"",Language:-1},lockedLanguage:null,rate:1,useControls:!1},this.playbar=b,this.forcedVoice=null,this.events={onBeforeItemPlaying:function(){},onItemLoaded:function(){},onSentenceComplete:function(){},onPause:function(){},onPlay:function(){},onResume:function(){}},this.internalEvents={onPause:function(){c.mutateControls(function(a){a.markAsPaused()}),!c.audioSource.ended&&c.audioSource.currentTime()>0&&c.events.onPause()},onPlay:function(){c.mutateControls(function(a){a.markAsPlaying()}),c.audioSource.currentTime()>0?c.events.onResume():c.events.onPlay()},onStop:function(){c.mutateControls(function(a){a.markAsPaused()})}},this.mutateControls=function(a){this.playbar.instance&&a(this.playbar.instance)},talkifyConfig.ui.audioControls.enabled&&(this.playbar.instance=talkifyPlaybar().subscribeTo({onTextHighlightingClicked:function(){c.settings.useTextHighlight=!c.settings.useTextHighlight}}))};BasePlayer.prototype.withReferenceLanguage=function(a){return this.settings.referenceLanguage=a,this},BasePlayer.prototype.withTextHighlighting=function(){return this.settings.useTextHighlight=!0,this.mutateControls(function(a){a.setTextHighlight(!0)}),this},BasePlayer.prototype.setRate=function(a){return this.settings.rate=a,this},BasePlayer.prototype.subscribeTo=function(a){return this.events.onBeforeItemPlaying=a.onBeforeItemPlaying||function(){},this.events.onSentenceComplete=a.onItemFinished||function(){},this.events.onPause=a.onPause||function(){},this.events.onPlay=a.onPlay||function(){},this.events.onResume=a.onResume||function(){},this.events.onItemLoaded=a.onItemLoaded||function(){},this},BasePlayer.prototype.generateGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)})},BasePlayer.prototype.playItem=function(a){var b=new promise.Promise;if(a&&a.isPlaying)return this.audioSource.paused()?this.audioSource.play():this.audioSource.pause(),b;this.events.onBeforeItemPlaying(a);var c=this;return a.isLoading=!0,a.isPlaying=!0,a.element.addClass("playing"),this.playAudio(a,function(){a.isPlaying=!1,b.done()}).then(function(){a.isLoading=!1,c.events.onItemLoaded()}),b},BasePlayer.prototype.createItems=function(a,b){function f(a,b){var c=b.length>0?$(b[0].outerHTML):$();return{text:a,preview:a.substr(0,40),element:b,originalElement:c,isPlaying:!1,isLoading:!1}}var c=1e3,d=[];if(a.length>c){var e=a.substr(0,c);return d.push(f(e,b)),d=d.concat(this.createItems(a.substr(c,a.length-1),b))}return d.push(f(a,b)),d},BasePlayer.prototype.playText=function(a){var b=this.createItems(a,$()),c=0,d=function(){c++,c>=b.length||this.playItem(b[c]).then(d)};this.playItem(b[c]).then(d)},BasePlayer.prototype.paused=function(){return this.audioSource.paused()},BasePlayer.prototype.isPlaying=function(){return this.audioSource.isPlaying()},BasePlayer.prototype.play=function(){this.audioSource.play()},BasePlayer.prototype.pause=function(){this.audioSource.pause();var a=this;!a.audioSource.paused()&&a.audioSource.cancel&&a.audioSource.cancel(!0)},BasePlayer.prototype.dispose=function(){this.wordHighlighter.cancel(),this.audioSource.stop(),this.internalEvents.onStop()},BasePlayer.prototype.forceLanguage=function(a){return this.settings.lockedLanguage=a,this},BasePlayer.prototype.forceVoice=function(a){return this.forcedVoice=a,this.mutateControls(function(b){b.setVoice(a)}),this};